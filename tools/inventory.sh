#!/bin/bash

if [ $# -eq 0 ]; then
    echo "No args provided."
    exit 1
fi

malware="$1"

# Creates names.txt file 
if [ ! -e names.txt ]; then
    touch names.txt
fi

echo "$(basename "$malware")" >> names.txt

mv "$malware" "${malware}.malware"

# Calculate hashes
hash_md5=$(md5sum "${malware}.malware" | awk '{print $1}')
hash_sha1=$(sha1sum "${malware}.malware" | awk '{print $1}')
hash_sha256=$(sha256sum "${malware}.malware" | awk '{print $1}')
hash_ssdeep=$(ssdeep -s "${malware}.malware" | tr -d ' ')

#  Create files with hashes
echo "$hash_md5" > "${hash_md5}.md5"
echo "$hash_sha1" > "${hash_md5}.sha1"
echo "$hash_sha256" > "${hash_md5}.sha256"
echo "${hash_ssdeep:41}" > "${hash_md5}.ssdeep" # ssdeep header not considered

touch README.md

mkdir -p rules
mkdir -p samples/"$(basename "${malware%.malware}")"

# Move files to samples
mv "${hash_md5}.md5" "${hash_md5}.sha1" "${hash_md5}.sha256" "${hash_md5}.ssdeep" samples/"$(basename "${malware%.malware}")"

mkdir -p info/"$(basename "${malware%.malware}")"

# Move files to info
mv README.md names.txt rules info/"$(basename "${malware%.malware}")"

# Zips malware and move it to samples
zip -P infected -j "samples/$(basename "${malware}")/${hash_md5}.zip" "${malware}.malware"

# Remove malware files
rm "${malware}.malware"
echo "Script finished"
echo "Please don't forget to add details to README.md and placing the folder in the appropiate directory."
