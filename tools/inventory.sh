#!/bin/bash

echo -e "\e[35m _                           _                               _     
(_)                         | |                             | |    
 _  _ __ __   __ ___  _ __  | |_  ___   _ __  _   _     ___ | |__  
| || '_ \  \ / // _ \| '_ \ | __|/ _ \ | '__|| | | |   / __|| '_ \ 
| || | | |\ V /|  __/| | | || |_| (_) || |   | |_| | _ \__ \| | | |
|_||_| |_| \_/  \___||_| |_| \__|\___/ |_|    \__, |(_)|___/|_| |_|
                                               __/ |               
                                              |___/                \e[0m"

if [ $# -eq 0 ]; then
    echo "No args provided."
    exit 1
fi

malware="$1"

# Creates names.txt file 
if [ ! -e names.txt ]; then
    touch names.txt
fi

echo "$(basename "$malware")" >> names.txt

echo -e "[\e[32m+\e[0m] Calculating hashes..."
# Calculate hashes
hash_md5=$(md5sum "${malware}" | awk '{print $1}')
hash_sha1=$(sha1sum "${malware}" | awk '{print $1}')
hash_sha256=$(sha256sum "${malware}" | awk '{print $1}')
hash_ssdeep=$(ssdeep -s "${malware}" | tr -d ' ')

#  Create files with hashes
echo "$hash_md5" > "${hash_md5}.md5"
echo "$hash_sha1" > "${hash_md5}.sha1"
echo "$hash_sha256" > "${hash_md5}.sha256"
echo "${hash_ssdeep:41}" > "${hash_md5}.ssdeep" # ssdeep header not considered

touch README.md

mkdir -p rules
mkdir -p samples/"$(basename "${malware}" | cut -d '.' -f 1)"

# Move files to samples
mv "${hash_md5}.md5" "${hash_md5}.sha1" "${hash_md5}.sha256" "${hash_md5}.ssdeep" samples/"$(basename "${malware}" | cut -d '.' -f 1)"

mkdir -p info/"$(basename "${malware}" | cut -d '.' -f 1)"

echo -e "[\e[33mi\e[0m] Building directory structure..."
# Move files to info
mv README.md names.txt rules info/"$(basename "${malware}" | cut -d '.' -f 1)"

echo -e "[\e[32m+\e[0m] Zipping malware sample..."
# Zips malware and move it to samples
zip -q -P infected -j "samples/$(basename "${malware}" | cut -d '.' -f 1)/${hash_md5}.zip" "${malware}"

echo -e "[\e[31m-\e[0m] Deleting PE sample..."
# Remove malware files
rm "$1"

echo -e "[\e[35m*\e[0m] Finished creating an inventory for the malware sample!"